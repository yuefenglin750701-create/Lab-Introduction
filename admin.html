<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦é©—å®¤å¾Œå°ç®¡ç†ç³»çµ± (Admin Dashboard)</title>
    
    <!-- 0. Global Error Handler -->
    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global Error:', msg, error);
            if (msg.indexOf("Script error") > -1) return true;
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 1. Sync Fallback Logic -->
    <script>
        window.isLocal = true;
        window.appId = 'default-app-id';
        
        window.enableLocalMode = () => {
            console.log("Initializing Local Mode...");
            window.isLocal = true;
            const getLocal = (key) => {
                try { return JSON.parse(localStorage.getItem('smsmp_' + key) || '[]'); } catch (e) { return []; }
            };
            const setLocal = (key, data) => localStorage.setItem('smsmp_' + key, JSON.stringify(data));

            window.signInAuth = async () => true; 
            window.dbOps = {
                signIn: async () => true,
                onAuth: (cb) => { setTimeout(() => cb({ uid: 'local-admin', email: 'admin@local' }), 50); return () => {}; },
                fetch: async (colName) => {
                    const data = getLocal(colName);
                    return Array.isArray(data) ? data : [];
                },
                add: async (colName, data) => {
                    const list = getLocal(colName);
                    const newItem = { ...data, id: 'loc_' + Date.now(), createdAt: Date.now() };
                    list.push(newItem);
                    setLocal(colName, list);
                    return newItem;
                },
                update: async (colName, id, data) => {
                    const list = getLocal(colName);
                    const idx = list.findIndex(i => i.id === id);
                    if (idx !== -1) {
                        list[idx] = { ...list[idx], ...data };
                        setLocal(colName, list);
                    }
                },
                delete: async (colName, id) => {
                    const list = getLocal(colName);
                    setLocal(colName, list.filter(i => i.id !== id));
                },
                batchAdd: async (colName, items) => {
                    const list = getLocal(colName);
                    const newItems = items.map((item, idx) => ({
                        ...item,
                        id: 'batch_' + Date.now() + '_' + idx,
                        createdAt: item.createdAt || (Date.now() - idx * 100)
                    }));
                    setLocal(colName, [...list, ...newItems]);
                },
                initDefaults: async (defaultData) => {
                    for (const [key, items] of Object.entries(defaultData)) {
                        if (getLocal(key).length === 0) {
                            const newItems = items.map((i, idx) => ({ ...i, id: `init_${idx}`, createdAt: Date.now() - (idx * 1000) }));
                            setLocal(key, newItems);
                        }
                    }
                }
            };
        };
        window.enableLocalMode();
    </script>

    <!-- 2. Firebase SDKs (Async Module) -->
    <script type="module">
        (async () => {
            try {
                // -----------------------------------------------------------
                // â˜…â˜…â˜… Firebase Config è¨­å®š (å·²å¡«å…¥) â˜…â˜…â˜…
                // -----------------------------------------------------------
                const userFirebaseConfig = {
                    apiKey: "AIzaSyB-3Pl_9_lQUUyfEzULjgnfgB8Xbivo5rY",
                    authDomain: "lab-website-40cb1.firebaseapp.com",
                    projectId: "lab-website-40cb1",
                    storageBucket: "lab-website-40cb1.firebasestorage.app",
                    messagingSenderId: "44092173556",
                    appId: "1:44092173556:web:c8283c28b229c01d4e42a1",
                    measurementId: "G-MYBL65WHRM"
                };

                let firebaseConfig = userFirebaseConfig;
                // ç’°å¢ƒè®Šæ•¸è¦†è“‹ (åƒ…é è¦½ç”¨)
                if (typeof __firebase_config !== 'undefined') {
                     // firebaseConfig = JSON.parse(__firebase_config);
                }

                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, writeBatch } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                window.isLocal = false; // Firebase loaded successfully

                window.signInAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                };

                // Overwrite dbOps with Firebase version (Matching API)
                window.dbOps = {
                    signIn: window.signInAuth,
                    onAuth: (cb) => onAuthStateChanged(window.auth, cb),
                    fetch: async (colName) => {
                        const colRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', colName);
                        const snapshot = await getDocs(colRef);
                        return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    },
                    add: async (colName, data) => {
                        const colRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', colName);
                        await addDoc(colRef, { ...data, createdAt: data.createdAt || Date.now() });
                    },
                    update: async (colName, id, data) => {
                        const docRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', colName, id);
                        await updateDoc(docRef, data);
                    },
                    delete: async (colName, id) => {
                        const docRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', colName, id);
                        await deleteDoc(docRef);
                    },
                    batchAdd: async (colName, items) => {
                        const batch = writeBatch(window.db);
                        const colRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', colName);
                        items.forEach((item, idx) => {
                             const docRef = doc(colRef);
                             const data = { ...item, createdAt: item.createdAt || (Date.now() - idx * 100) };
                             batch.set(docRef, data);
                        });
                        await batch.commit();
                    },
                    initDefaults: async (defaultData) => {
                        const batch = writeBatch(window.db);
                        for (const [key, items] of Object.entries(defaultData)) {
                            const colRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', key);
                            const snapshot = await getDocs(colRef);
                            if (snapshot.empty) {
                                items.forEach((item, idx) => {
                                    const docRef = doc(colRef);
                                    batch.set(docRef, { ...item, createdAt: Date.now() - (idx * 1000) });
                                });
                            }
                        }
                        await batch.commit();
                    }
                };
                console.log("ğŸ”¥ Firebase Connected");
                
                // Force re-render if React already mounted in local mode
                if (window.forceUpdateAuth) window.forceUpdateAuth();

            } catch (e) {
                console.warn("âš ï¸ Firebase failed, staying in Local Mode", e);
            }
        })();
    </script>
</head>
<body class="bg-gray-100 font-sans text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return <div className="min-h-screen flex items-center justify-center bg-red-50 p-4"><div className="bg-white p-6 rounded shadow text-center text-red-600">ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ã€‚<br/><span className="text-sm text-gray-400">{this.state.error?.message}</span></div></div>;
                }
                return this.props.children;
            }
        }

        const CRED_KEY_USER = 'smsmp_admin_user';
        const CRED_KEY_PASS = 'smsmp_admin_pass';
        const DEFAULT_USER = 'Yflin';
        const DEFAULT_PASS = '0701';

        const getCredentials = () => ({
            username: localStorage.getItem(CRED_KEY_USER) || DEFAULT_USER,
            password: localStorage.getItem(CRED_KEY_PASS) || DEFAULT_PASS
        });

        const updateCredentials = (u, p) => { localStorage.setItem(CRED_KEY_USER, u); localStorage.setItem(CRED_KEY_PASS, p); };

        // â˜…â˜…â˜… å·²æ›´æ–°ç‚ºæ‚¨ä¸Šå‚³æª”æ¡ˆä¸­çš„çœŸå¯¦è³‡æ–™ â˜…â˜…â˜…
        const defaultData = {
            news: [
                { date: "2025-11-06", title: "114å¹´ å°ç£ç²¾å¯†å·¥ç¨‹å­¸æœƒâ€§æ±å°é›†åœ˜ã€ç²¾å¯†å·¥ç¨‹å°ˆé¡Œèˆ‡è«–æ–‡çã€‘ï¼Œæ¦®ç²ç ”ç©¶è«–æ–‡çä½³ä½œ", tag: "Award" },
                { date: "2025-11-06", title: "114å¹´ å°ç£ç²¾å¯†å·¥ç¨‹å­¸æœƒâ€§æ±å°é›†åœ˜ã€ç²¾å¯†å·¥ç¨‹å°ˆé¡Œèˆ‡è«–æ–‡çã€‘ï¼Œæ¦®ç²å¤§å°ˆå°ˆé¡Œçä½³ä½œ", tag: "Award" },
                { date: "2025-06-18", title: "114å¹´å°ä¸­ç²¾æ©Ÿç›ƒ CNCç¬¬ä¸‰å±†å…¨åœ‹å¤šè»¸æ©Ÿçµ„æŠ€èƒ½ç«¶è³½ï¼Œæ¦®ç²ç¬¬å…­å", tag: "Award" },
                { date: "2024-06-02", title: "113å¹´å°ä¸­ç²¾æ©Ÿç›ƒ CNCç¬¬äºŒå±†å…¨åœ‹å¤šè»¸æ©ŸæŠ€èƒ½ç«¶è³½ï¼Œæ¦®ç²ç¬¬ä¸‰å", tag: "Award" },
                { date: "2023-12-01", title: "2023å¹´ä¸­åœ‹æ©Ÿæ¢°å·¥ç¨‹å­¸æœƒç¬¬40å±†å…¨åœ‹å­¸è¡“ç ”è¨æœƒæš¨å­¸ç”Ÿè«–æ–‡ç™¼è¡¨ç«¶è³½ï¼Œæ¦®ç²åœ‹ç§‘æœƒæ©Ÿæ¢°å›ºåŠ›èˆ‡ç†±æµå­¸é–€ç¬¬ä¸‰å", tag: "Award" },
                { date: "2023-10-28", title: "2023å¹´ã€CTTT 2023 ç¬¬å…­å±†è‡ºç£ç£¨æ½¤ç§‘æŠ€ç ”è¨æœƒã€ï¼Œæ¦®ç²ç‰¹åˆ¥ç", tag: "Award" },
                { date: "2023-10-14", title: "2023å¹´ç¬¬åäºŒå±†ä¸­èˆˆå¤§å­¸ã€ç²¾å¯†å·¥å…·æ©Ÿèˆ‡æ™ºæ…§åŒ–æŠ€è¡“ã€å°ˆé¡Œä½œç«¶è³½ï¼Œæ¦®ç²å…¨åœ‹ç¬¬äºŒå", tag: "Award" },
                { date: "2023-04-28", title: "2023å¹´ã€ISMEç¬¬å…«å±†å°ç£æ©Ÿé›»å·¥ç¨‹åœ‹éš›å­¸æœƒå…¨åœ‹å­¸è¡“ç ”è¨æœƒã€ï¼Œæ¦®ç²å…ˆé€²è¤‡åˆææ–™è«–å£‡æœ€ä½³è«–æ–‡ç", tag: "Award" },
                { date: "2023-04-16", title: "112å¹´ã€å°ä¸­ç²¾æ©Ÿç›ƒCNCå¤šè»¸æ©ŸæŠ€èƒ½ç«¶è³½ã€ï¼Œæ¦®ç²å…¨åœ‹ç¬¬ä¸ƒå", tag: "Award" },
                { date: "2020-11-20", title: "2020å¹´æ™ºæ…§æ©Ÿæ¢° SMB APP ç«¶è³½ï¼Œæ¦®ç²ä½³ä½œ", tag: "Award" },
                { date: "2020-11-07", title: "2020å¹´ã€å…¨åœ‹ç£¨æ½¤ç§‘æŠ€å¯¦å‹™æŠ€è¡“ç«¶è³½ã€ï¼Œæ¦®ç²æœ€ä½³æŠ€è¡“å‘ˆç¾ç", tag: "Award" },
                { date: "2020-10-15", title: "2020å¹´ã€å…¨åœ‹ä¸‰è±é›»æ©ŸCNCæ™ºèƒ½APPå‰µæ„é–‹ç™¼ç«¶è³½ã€ï¼Œæ¦®ç²ç¬¬ä¸€å", tag: "Award" },
                { date: "2020-09-26", title: "2020å¹´ç¬¬ä¹å±†ä¸­èˆˆå¤§å­¸ã€ç²¾å¯†å·¥å…·æ©Ÿèˆ‡æ™ºæ…§åŒ–æŠ€è¡“ã€å°ˆé¡Œå¯¦ä½œç«¶è³½ï¼Œæ¦®ç²ç¬¬äºŒå", tag: "Award" },
                { date: "2020-08-28", title: "2020å¹´å°ç£å·¥ç¨‹åœ‹éš›å­¸æœƒå…¨åœ‹å­¸è¡“ç ”è¨æœƒç¦æ˜Ÿç†±èƒ½å‰µæ„ç«¶è³½ï¼Œæ¦®ç²ä½³ä½œ", tag: "Award" }
            ],
            projects: [
                // å°ˆåˆ©
                { type: "patent", year: "2024/04/21", title: "æ™¶éŒ åˆ‡å‰²è£ç½®", agency: "I840267", role: "ç™¼æ˜äºº: æ—å²³é‹’ã€è”¡æ˜ç¾©ã€åš´ä»•è‚²ã€åŠ‰è“å§" },
                { type: "patent", year: "2021/10/11", title: "è‡ªå‹•æ“ è†æ‹‹å…‰åˆ€æŠŠ", agency: "I742924", role: "ç™¼æ˜äºº: è”¡æ˜ç¾©ã€éƒ­ä¿ŠéºŸã€æ—å²³é‹’ã€é»ƒå®ˆæ­£" },
                { type: "patent", year: "2021/06/01", title: "è‡ªå‹•å°åˆ€è£ç½®ä»¥åŠç£¨åºŠ", agency: "M612712", role: "ç™¼æ˜äºº: è”¡æ˜ç¾©ã€æ—å²³é‹’ã€é™³ä¿Šå»¶" },
                { type: "patent", year: "2019/04/21", title: "å¯èª¿å¼å£“å½ˆç°§åˆ€æŠŠ", agency: "I656941", role: "ç™¼æ˜äºº: è”¡æ˜ç¾©ã€éƒ­ä¿ŠéºŸã€æ—å²³é‹’" },
                // åœ‹ç§‘æœƒ
                { type: "government", year: "114/06/01-115/05/31", title: "é«˜é•·å¾‘æ¯”æ¸›æŒ¯è»Šåˆ€æ¡¿è¨­è¨ˆèˆ‡æ™ºèƒ½æªå­”åŠ å·¥åƒæ•¸å„ªåŒ–ç³»çµ±é–‹ç™¼", agency: "NSTC-114-2622-E-167-003", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "government", year: "113/08/01-114/07/31", title: "æ‡‰ç”¨å€’å‚³éé¡ç¥ç¶“ç¶²è·¯çµåˆè¶…éŸ³æ³¢éœ‡å‹•è¼”åŠ©èˆ‡è¨Šè™Ÿæ“·å–åˆ†ææŠ€è¡“æ–¼å¾®éŠ‘å‰ŠåŠ å·¥å–®æ™¶ç¢³åŒ–çŸ½æ™¶ç¢‡ä¹‹ç ”ç©¶", agency: "NSTC-113-2221-E-167-027", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "government", year: "113/02/01-114/01/31", title: "é›£åˆ‡å‰ŠåŠ å·¥æŠ€è¡“èˆ‡è£½ç¨‹é–‹ç™¼ç”¢å­¸è¯ç›Ÿ(3/3)", agency: "NSTC-113-2622-8-167-001-TE3", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "government", year: "112/06/01-113/05/31", title: "é«˜é•·å¾‘æ¯”(L/D=12)æ¸›éœ‡åˆ€æ¡¿è¨­è¨ˆé–‹ç™¼", agency: "NSTC-112-2622-E-167-003", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "government", year: "112/02/01-113/01/31", title: "é›£å‰ŠæåŠ å·¥æŠ€è¡“èˆ‡è£½ç¨‹é–‹ç™¼ç”¢å­¸è¯ç›Ÿ(2/3)", agency: "NSTC-112-2622-8-167-001-TE3", role: "è¨ˆç•«ä¸»æŒäºº" },
                // ç”¢å­¸åˆä½œ (ç¯€éŒ„éƒ¨åˆ†ä»£è¡¨æ€§)
                { type: "industry", year: "114/02/14 ~ 114/11/30", title: "æ¶²éœå£“ç£¨åºŠä¹‹AIè‡ªé©æ‡‰åŠ å·¥åƒæ•¸å„ªåŒ–èˆ‡æ™ºæ…§åˆ€å…·ç£¨æè£œå„Ÿç³»çµ±é–‹ç™¼", agency: "å¤§å…‰é•·æ¦®æ©Ÿæ¢°", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "industry", year: "114/02/14 ~ 114/11/30", title: "æ™ºæ…§å¤šè»¸å·¥å…·æ©ŸåŠ å·¥èƒ½æ•ˆç®¡ç†èˆ‡å…§è—å¼ä¸»è»¸å†·å»æŠ€è¡“å„ªåŒ–ç ”ç©¶", agency: "å‡±æŸç²¾å¯†æ©Ÿæ¢°", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "industry", year: "113/09/01 ~ 114/05/31", title: "é©ç”¨æ–¼å°è–„æ™¶ç‰‡ä¹‹é«˜å–ç‰‡è‰¯ç‡é ‚é‡çµ„é–‹ç™¼è¨ˆç•«", agency: "è±ªå³°ç§‘æŠ€", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "industry", year: "113/06/01 ~ 114/05/31", title: "ç·šåˆ‡å‰²é«˜æ•ˆç¯€èƒ½ç”¢ç·šè¦åŠƒåŠé©—è­‰", agency: "ç«‹æ³‰ç·šåˆ‡å‰²", role: "è¨ˆç•«ä¸»æŒäºº" },
                { type: "industry", year: "113/05/01 ~ 113/12/31", title: "åŠå°é«”åœ‹éš›é€£çµå‰µæ–°è³¦èƒ½è¨ˆåŠƒ", agency: "å°ç£å¹³å¦åŒ–æ‡‰ç”¨æŠ€è¡“å”æœƒ", role: "è¨ˆç•«ä¸»æŒäºº" }
            ],
            members: [
                { 
                    type: 'pi', 
                    name: "æ—å²³é‹’ (Dr. Yan-Fa Lin)", 
                    year: "", 
                    research: "å‰µæ–°é«˜æ•ˆèƒ½åŠ å·¥, ç ”ç£¨/æ‹‹å…‰åŠ å·¥æŠ€è¡“é–‹ç™¼, æ™ºæ…§è£½é€ æŠ€è¡“é–‹ç™¼, ç·šä¸ŠåŠ å·¥æ„Ÿæ¸¬è¨Šè™Ÿå³æ™‚åˆ†æè¨ºæ–·å›æœ”æ§åˆ¶, å¤§æ•¸æ“šåŠ å·¥è³‡æ–™åº«æ¢å‹˜", 
                    researchDetail: "æ—å²³é‹’å‰¯æ•™æˆç¾ä»»åœ‹ç«‹å‹¤ç›Šç§‘æŠ€å¤§å­¸æ©Ÿæ¢°å·¥ç¨‹ç³»å‰¯ä¸»ä»»ã€‚ç ”ç©¶å°ˆé•·ç‚ºéå‚³çµ±åŠ å·¥æŠ€è¡“ã€æ™ºæ…§è£½é€ æ„Ÿæ¸¬ã€åŠ å·¥å“è³ªè©•ä¼°èˆ‡ææ–™æ®˜é¤˜æ‡‰åŠ›åˆ†æã€‚å…¶ç ”ç©¶çµåˆå¯¦éš›åŠ å·¥å¯¦é©—ã€å³æ™‚æ„Ÿæ¸¬èˆ‡è³‡æ–™åˆ†ææ–¹æ³•ï¼Œæ‡‰ç”¨æ–¼é«˜ç¡¬åº¦ææ–™èˆ‡åŠå°é«”è£½ç¨‹å“è³ªæå‡ã€‚", 
                    email: "yflin@ncut.edu.tw", 
                    phone: "04-23924505 åˆ†æ©Ÿ 7173",
                    awards: "å¼·èª¿ã€Œå¯¦æ©Ÿæ“ä½œå°å‘ (Machine-based Learning)ã€èˆ‡ã€Œè£½ç¨‹æ•¸æ“šåˆ†æã€ï¼Œå¼•å°å­¸ç”Ÿç”±ã€Œç¾è±¡ â†’ æ¨¡å‹ â†’ é©—è­‰ã€å»ºç«‹å·¥ç¨‹åˆ¤æ–·èƒ½åŠ›ã€‚", 
                    photo: "391692351_7466255803389344_4203488068870191778_n.jpg",
                    pdfs: [] 
                }
                // å­¸ç”Ÿè³‡æ–™ä¿ç•™ç¯„ä¾‹ï¼Œå› æ–‡ä»¶ä¸­ç„¡è©³ç´°åå–®
            ],
            gallery: [],
            publications: [
                { year: "To be published", title: "Scalable Real-time Energy Monitoring, Analysis, and Optimization in Five-axis Machine Tools: An Industrial Internet of Energy-based Approach", venue: "Sensors and Materials", authors: "Swami Nath Maurya, Kun-Ying Li, Windu Aditya Nur Faeza, Yue-Feng Lin" },
                { year: "2025/10", title: "Geometric-overlap Modeling and Sweep Uniformity Optimization of Fixed Diamond Conditioning Disks for Chemical Mechanical Planarization", venue: "Sensors and Materials 37(10)", authors: "Yu-Chen Wang, Hong-Hui Lian, Yue-Feng Lin, Ming-Yi Tsai" },
                { year: "2025/05", title: "Raman-Based Residual Stress Measurement and Defect Evaluation in Multistage-Processed 4H-SiC Wafers", venue: "Materials Today", authors: "Yu-Chen Wang, Hong-Hui Lian, Yue-Feng Lin, Ming-Yi Tsai" },
                { year: "2024/12", title: "Optimization of surface roughness and cylindricity using the Taguchi method in boring of S45C steel with tungsten steel and phosphor bronze damping materials", venue: "Int. J. Adv. Manuf. Tech.", authors: "Yue-Feng Lin*, Pei-Yu Lai, Guan-Yu Chen, Zi-Peng Zhang" },
                { year: "2024/09", title: "On-machine Fabrication of Boron-doped Polycrystalline Diamond Cutting Tools by Combining Wire Electrical Discharge Machining and Abrasive Grinding", venue: "Sensors and Materials 36(9)", authors: "Yue-Feng Lin*, Pei-Yu Lai, Yuan-Xiu Luo" },
                { year: "2024/09", title: "Dissipation Energy as a Method for Sensing the Tribology Mechanism", venue: "Sensors and Materials 36(9)", authors: "Shih-Chen Shi*, Tao-Hsing Chen, Chih-Chia Wang, Hao-Fu Zhang, Yue-Feng Lin, Dieter Rahmadiawan" },
                { year: "2022/11", title: "Aluminum and alumina/MoS2/cellulose derivative composite: design and performance", venue: "Materials Research Express 9(11)", authors: "Shih-Chen Shi*, Shia-Seng Pek, Yue-Feng Lin" },
                { year: "2022/06", title: "Electrical Properties of Spin-coated Indium Tin Oxide for Photosensor Applications", venue: "Sensors and Materials 34(6)", authors: "Shih-Chen Shi*, Jian-An Chen, Yue-Feng Lin, Chih-Chia Wang" },
                { year: "2021/10", title: "Monitoring of Grinding Status of Alumina Grinding Wheel Based on Short-time Fourier Transform", venue: "Sensors and Materials 33(10)", authors: "Kun-Ying Li, Yue-Feng Lin, Ming-Yi Tsai*, I-Cheng Chiu, Jyun-Yan Chen" },
                { year: "2021/05", title: "Stator flux oriented multiple sliding-mode speed control design of induction motor drives", venue: "Advances in Mechanical Engineering 13(5)", authors: "Hsiu-Ming Wu*, Yue-Feng Lin, Chien-Hsu Chen" },
                { year: "2020/12", title: "Surface Characterization and Tribological Behavior of Graphene-Reinforced Cellulose Composites Prepared by Large-Area Spray Coating on Flexible Substrate", venue: "Coatings 10(12)", authors: "Shih-Chen Shi*, Chih-Chia Wang, Yung-Chen Cheng, Yue-Feng Lin" }
            ]
        };

        const TAB_NAMES = { news: 'æœ€æ–°æ¶ˆæ¯', projects: 'æ­·å¹´è¨ˆç•«', members: 'æˆå“¡ç®¡ç†', publications: 'ç™¼è¡¨è«–æ–‡', gallery: 'ç”Ÿæ´»å¯«çœŸ' };
        const FolderIcon = ({ className = "w-16 h-16 text-yellow-400 mb-2 drop-shadow-sm group-hover:scale-110 transition-transform" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path d="M19.5 21a3 3 0 0 0 3-3v-4.5a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3h15ZM1.5 10.146V6a3 3 0 0 1 3-3h5.379a2.25 2.25 0 0 1 1.59.659l2.122 2.121c.14.141.331.22.53.22H19.5a3 3 0 0 1 3 3v1.146A4.483 4.483 0 0 0 19.5 9h-15a4.483 4.483 0 0 0-3 1.146Z" />
            </svg>
        );

        // --- Image Compressor Utility ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Limit Max Dimensions
                        const MAX_WIDTH = 1024;
                        const MAX_HEIGHT = 1024;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to JPEG 0.6 Quality
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        resolve(dataUrl);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const LoginForm = ({ onLogin }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [err, setErr] = useState('');
            const [localMode, setLocalMode] = useState(window.isLocal);
            useEffect(() => { const i = setInterval(() => setLocalMode(window.isLocal), 500); return () => clearInterval(i); }, []);
            const handleSubmit = (e) => {
                e.preventDefault();
                const creds = getCredentials();
                if (u === creds.username && p === creds.password) onLogin();
                else setErr('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm border border-slate-200">
                        <h2 className="text-xl font-bold mb-6 text-center text-slate-800">å¾Œå°ç™»å…¥</h2>
                        <div className={`mb-4 text-xs p-2 rounded flex items-center ${localMode ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                            <span className="mr-2">{localMode ? 'âš ï¸' : 'âœ…'}</span> 
                            <span>{localMode ? 'æœ¬æ©Ÿæ¨¡å¼ (Firebase æœªé€£ç·š)' : 'å·²é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«'}</span>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full border p-2 rounded" placeholder="å¸³è™Ÿ" value={u} onChange={e=>setU(e.target.value)} required />
                            <input className="w-full border p-2 rounded" type="password" placeholder="å¯†ç¢¼" value={p} onChange={e=>setP(e.target.value)} required />
                            {err && <p className="text-red-500 text-center text-sm">{err}</p>}
                            <button className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition-colors">ç™»å…¥</button>
                        </form>
                    </div>
                </div>
            );
        };

        const EditorModal = ({ activeTab, initData, onSave, onBatchSave, onClose }) => {
            const [formData, setFormData] = useState({});
            const [galleryImages, setGalleryImages] = useState([]);
            const [coverIndex, setCoverIndex] = useState(0);
            const [customInput, setCustomInput] = useState({ year: false, role: false, classYear: false, yearDisplay: false });
            const [isSaving, setIsSaving] = useState(false);
            const [processingMsg, setProcessingMsg] = useState('');

            useEffect(() => {
                const d = { ...initData };
                if (activeTab === 'members' && !d.type) d.type = 'master';
                // Initialize default values for new items
                if (!d.id) {
                    if (activeTab === 'projects') d.type = 'government';
                    if (activeTab === 'members') d.year = 'ç¢©ä¸€';
                    if (activeTab === 'news') d.tag = 'Activity';
                }
                setFormData(d);
                if (activeTab === 'gallery') {
                    setGalleryImages(d.src ? [{src: d.src, id: 'init'}] : []);
                    setCoverIndex(0);
                }
                setCustomInput({ year: false, role: false, classYear: false, yearDisplay: false });
            }, [initData, activeTab]);

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            
            const processFiles = async (files) => {
                setProcessingMsg(`æ­£åœ¨å£“ç¸® ${files.length} å¼µåœ–ç‰‡...`);
                setIsSaving(true);
                const processed = [];
                
                try {
                    for (const file of files) {
                        const compressedDataUrl = await compressImage(file);
                        processed.push({ src: compressedDataUrl, id: Math.random() });
                    }
                    
                    if (activeTab === 'gallery') {
                        setGalleryImages(prev => [...prev, ...processed]);
                    } else {
                        // For single image fields, take the first one
                        if (processed.length > 0) {
                            const field = activeTab === 'members' ? 'photo' : 'image';
                            setFormData(prev => ({ ...prev, [field]: processed[0].src }));
                        }
                    }
                } catch(e) {
                    alert("åœ–ç‰‡è™•ç†å¤±æ•—: " + e.message);
                }
                
                setIsSaving(false);
                setProcessingMsg('');
            };

            const handleFiles = (e) => {
                const files = Array.from(e.target.files);
                processFiles(files);
            };

            const handlePaste = (e) => {
                if (activeTab !== 'gallery') return;
                const items = e.clipboardData.items;
                const files = [];
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        files.push(items[i].getAsFile());
                    }
                }
                if (files.length > 0) processFiles(files);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                setProcessingMsg('è³‡æ–™å„²å­˜ä¸­...');
                try {
                    if (activeTab === 'gallery' && !formData.id && galleryImages.length > 0) {
                        const items = galleryImages.map((img, idx) => {
                            const offset = idx === coverIndex ? 0 : (idx + 1) * 1000;
                            return { ...formData, src: img.src, createdAt: Date.now() - offset };
                        });
                        await onBatchSave(items); 
                        onClose();
                    } else {
                        if (activeTab === 'gallery' && galleryImages.length > 0) formData.src = galleryImages[0].src;
                        await onSave(formData);
                        onClose();
                    }
                } catch (err) {
                    console.error(err);
                    alert("å„²å­˜ç™¼ç”ŸéŒ¯èª¤: " + err.message);
                } finally {
                    setIsSaving(false);
                    setProcessingMsg('');
                }
            };

            // Options
            const isMember = activeTab === 'members';
            const isGallery = activeTab === 'gallery';
            const isPI = formData.type === 'pi';
            const isAlumni = formData.type === 'alumni';
            const isStudent = ['master', 'phd'].includes(formData.type);
            const yearOptions = [];
            for (let y = 116; y >= 105; y--) yearOptions.push({ val: String(y), label: `æ°‘åœ‹ ${y} å¹´` });
            for (let y = 2030; y >= 2016; y--) yearOptions.push({ val: String(y), label: `è¥¿å…ƒ ${y} å¹´` });
            const memberClassYears = [];
            for (let y = 116; y >= 80; y--) memberClassYears.push(String(y));
            const memberYearDisplays = ["ç¢©ä¸€", "ç¢©äºŒ", "ç¢©ä¸‰", "åšä¸€", "åšäºŒ", "åšä¸‰", "åšå››", "åšäº”"];

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onPaste={handlePaste}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto relative">
                        {isSaving && (
                            <div className="absolute inset-0 bg-white/80 z-50 flex items-center justify-center flex-col">
                                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-2"></div>
                                <div className="text-blue-600 font-bold">{processingMsg}</div>
                            </div>
                        )}
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <h3 className="text-xl font-bold">{formData.id ? 'ç·¨è¼¯' : 'æ–°å¢'} {isGallery ? '(ç›¸ç°¿æ¨¡å¼)' : ''}</h3>
                            <div>
                                <label className="block text-sm font-bold mb-1">{isMember ? 'å§“å' : 'æ¨™é¡Œ'}</label>
                                <input required name={isMember ? 'name' : 'title'} value={(isMember ? formData.name : formData.title) || ''} onChange={handleChange} className="w-full border p-2 rounded" />
                                {isGallery && <p className="text-xs text-gray-500 mt-1">ç›¸åŒæ¨™é¡Œçš„ç…§ç‰‡æœƒè‡ªå‹•æ­¸é¡ç‚ºåŒä¸€æœ¬ç›¸ç°¿ã€‚</p>}
                            </div>
                            
                            {/* Member Specific Fields */}
                            {isMember && (
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-1">èº«åˆ†</label>
                                        <select name="type" value={formData.type} onChange={handleChange} className="w-full border p-2 rounded">
                                            <option value="pi">æŒ‡å°æ•™æˆ</option>
                                            <option value="phd">åšå£«ç”Ÿ</option>
                                            <option value="master">ç¢©å£«ç”Ÿ</option>
                                            <option value="alumni">ç•¢æ¥­æ ¡å‹</option>
                                        </select>
                                    </div>
                                    <div>
                                        {isAlumni ? (
                                            <>
                                                <label className="block text-sm font-bold mb-1">ç•¢æ¥­ç´šåˆ¥</label>
                                                {!customInput.classYear ? (
                                                    <select name="classYear" value={memberClassYears.includes(formData.classYear) ? formData.classYear : 'custom'} onChange={(e) => {
                                                        if(e.target.value === 'custom') setCustomInput(p => ({...p, classYear: true}));
                                                        else setFormData(p => ({...p, classYear: e.target.value}));
                                                    }} className="w-full border p-2 rounded">
                                                        <option value="" disabled>è«‹é¸æ“‡</option>
                                                        {memberClassYears.map(y => <option key={y} value={y}>{y}ç´š</option>)}
                                                        <option value="custom">è‡ªè¨‚...</option>
                                                    </select>
                                                ) : (
                                                    <div className="flex gap-2"><input name="classYear" value={formData.classYear||''} onChange={handleChange} className="w-full border p-2 rounded" placeholder="e.g. 113" /><button type="button" onClick={() => setCustomInput(p=>({...p, classYear: false}))} className="px-2 bg-gray-200 rounded text-xs">é¸å–®</button></div>
                                                )}
                                            </>
                                        ) : (isStudent && (
                                            <>
                                                <label className="block text-sm font-bold mb-1">å¹´ç´š</label>
                                                {!customInput.yearDisplay ? (
                                                    <select name="year" value={memberYearDisplays.includes(formData.year) ? formData.year : 'custom'} onChange={(e) => {
                                                        if(e.target.value === 'custom') setCustomInput(p => ({...p, yearDisplay: true}));
                                                        else setFormData(p => ({...p, year: e.target.value}));
                                                    }} className="w-full border p-2 rounded">
                                                        <option value="" disabled>è«‹é¸æ“‡</option>
                                                        {memberYearDisplays.map(y => <option key={y} value={y}>{y}</option>)}
                                                        <option value="custom">è‡ªè¨‚...</option>
                                                    </select>
                                                ) : (
                                                    <div className="flex gap-2"><input name="year" value={formData.year || ''} onChange={handleChange} placeholder="e.g. ç¢©ä¸€" className="w-full border p-2 rounded" /><button type="button" onClick={() => setCustomInput(p=>({...p, yearDisplay: false}))} className="px-2 bg-gray-200 rounded text-xs">é¸å–®</button></div>
                                                )}
                                            </>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'news' && <input type="date" name="date" value={formData.date||''} onChange={handleChange} className="w-full border p-2 rounded" />}
                            
                            {activeTab === 'projects' && (
                                <>
                                    <label className="block"><span className="text-sm font-bold">å¹´åº¦</span>
                                        {!customInput.year ? (
                                            <select name="year" value={yearOptions.some(o => o.val === formData.year) ? formData.year : 'custom'} onChange={(e) => {
                                                if(e.target.value === 'custom') setCustomInput(p => ({...p, year: true}));
                                                else setFormData(p => ({...p, year: e.target.value}));
                                            }} className="w-full border p-2 rounded mt-1"><option value="" disabled>è«‹é¸æ“‡å¹´åº¦</option>{yearOptions.map(opt => <option key={opt.val} value={opt.val}>{opt.label}</option>)}<option value="custom">è‡ªè¨‚...</option></select>
                                        ) : <div className="flex gap-2"><input name="year" value={formData.year || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1" /><button type="button" onClick={() => setCustomInput(p=>({...p, year: false}))} className="px-2 bg-gray-200 rounded mt-1 text-xs">é¸å–®</button></div>}
                                    </label>
                                    <input name="type" placeholder="é¡å‹" value={formData.type||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                    <input name="agency" placeholder="å–®ä½" value={formData.agency||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                    <input name="role" placeholder="æ“”ä»»è§’è‰²" value={formData.role||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                    <textarea name="desc" placeholder="èªªæ˜" value={formData.desc||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                </>
                            )}

                            {isGallery ? (
                                <div className="border-2 border-dashed p-4 rounded bg-gray-50">
                                    <div className="flex justify-between mb-2">
                                        <label className="font-bold text-sm">ç›¸ç°¿ç…§ç‰‡ (å¤šé¸/è²¼ä¸Š)</label>
                                        <span className="text-xs bg-green-100 text-green-800 px-2 rounded">é»æ“Šè¨­ç‚ºå°é¢</span>
                                    </div>
                                    <input type="file" accept="image/*" multiple onChange={handleFiles} className="mb-2 w-full text-sm" />
                                    <div className="grid grid-cols-4 gap-2">
                                        {galleryImages.map((img, idx) => (
                                            <div key={idx} onClick={() => setCoverIndex(idx)} className={`relative aspect-square cursor-pointer border-2 ${idx===coverIndex ? 'border-green-500' : 'border-transparent'}`}>
                                                <img src={img.src} className="w-full h-full object-cover" />
                                                {idx===coverIndex && <div className="absolute top-0 left-0 bg-green-500 text-white text-[10px] px-1">å°é¢</div>}
                                                <button type="button" onClick={(e)=>{e.stopPropagation();setGalleryImages(prev=>prev.filter((_,i)=>i!==idx))}} className="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center rounded-bl">Ã—</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                ['news', 'members'].includes(activeTab) && (
                                    <div>
                                        <label className="block text-sm font-bold mb-1">åœ–ç‰‡ (è‡ªå‹•å£“ç¸®)</label>
                                        <input type="file" accept="image/*" onChange={handleFiles} className="w-full border p-2 rounded text-sm" />
                                        {formData[activeTab==='members'?'photo':'image'] && <img src={formData[activeTab==='members'?'photo':'image']} className="h-20 mt-2 border rounded" />}
                                    </div>
                                )
                            )}
                            
                            {isMember && (
                                <>
                                    <input name="research" placeholder={isPI ? 'æ ¸å¿ƒç ”ç©¶é ˜åŸŸ' : 'ç ”ç©¶ä¸»é¡Œ'} value={formData.research || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>
                                    <textarea name="researchDetail" placeholder={isPI ? 'å­¸è¡“ç°¡ä»‹' : 'è©³ç´°å…§å®¹'} value={formData.researchDetail || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1 h-20"/>
                                    <input name="email" placeholder="Email" value={formData.email || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>
                                    {isPI && <input name="phone" placeholder="é›»è©±" value={formData.phone || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>}
                                    <textarea name="awards" placeholder={isPI ? 'æ•™å­¸ç‰¹è‰²' : 'ç²çç´€éŒ„'} value={formData.awards || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>
                                </>
                            )}
                            {activeTab === 'publications' && <input name="venue" placeholder="æœŸåˆŠ/ç ”è¨æœƒ" value={formData.venue||''} onChange={handleChange} className="w-full border p-2 rounded"/>}
                            {activeTab === 'gallery' && <input name="desc" placeholder="ç›¸ç°¿æè¿°" value={formData.desc||''} onChange={handleChange} className="w-full border p-2 rounded" />}

                            <div className="flex justify-end gap-2 pt-4">
                                <button type="button" onClick={onClose} disabled={isSaving} className="px-4 py-2 border rounded disabled:opacity-50">å–æ¶ˆ</button>
                                <button type="submit" disabled={isSaving} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                    {isSaving ? 'è™•ç†ä¸­...' : 'å„²å­˜'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ChangePasswordModal = ({ isOpen, onClose }) => {
            const [oldUser, setOldUser] = useState('');
            const [oldPass, setOldPass] = useState('');
            const [newPass, setNewPass] = useState('');
            const [confirmPass, setConfirmPass] = useState('');
            const [msg, setMsg] = useState({ type: '', text: '' });
            const handleSubmit = (e) => {
                e.preventDefault();
                const current = getCredentials();
                if (oldUser !== current.username || oldPass !== current.password) { setMsg({ type: 'error', text: 'èˆŠå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤' }); return; }
                if (newPass !== confirmPass) { setMsg({ type: 'error', text: 'å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´' }); return; }
                if (newPass.length < 4) { setMsg({ type: 'error', text: 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 4 ç¢¼' }); return; }
                updateCredentials(current.username, newPass); 
                setMsg({ type: 'success', text: 'å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼' });
                setTimeout(() => { setMsg({ type: '', text: '' }); onClose(); }, 1500);
            };
            useEffect(() => { if(isOpen) { setOldUser(''); setOldPass(''); setNewPass(''); setConfirmPass(''); setMsg({type:'', text:''}); } }, [isOpen]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <h3 className="text-xl font-bold mb-4">ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
                        {msg.text && <div className={`p-2 mb-4 rounded text-sm ${msg.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{msg.text}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded border border-slate-200"><input type="text" placeholder="ç›®å‰çš„å¸³è™Ÿ" value={oldUser} onChange={e => setOldUser(e.target.value)} className="w-full border p-2 rounded mb-2 text-sm" required /><input type="password" placeholder="ç›®å‰çš„å¯†ç¢¼" value={oldPass} onChange={e => setOldPass(e.target.value)} className="w-full border p-2 rounded text-sm" required /></div>
                            <div className="bg-blue-50 p-3 rounded border border-blue-100"><input type="password" placeholder="æ–°å¯†ç¢¼" value={newPass} onChange={e => setNewPass(e.target.value)} className="w-full border p-2 rounded mb-2 text-sm" required /><input type="password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" value={confirmPass} onChange={e => setConfirmPass(e.target.value)} className="w-full border p-2 rounded text-sm" required /></div>
                            <div className="flex justify-end space-x-3 mt-4"><button type="button" onClick={onClose} className="px-4 py-2 border rounded text-slate-600 hover:bg-slate-50">å–æ¶ˆ</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ç¢ºèªä¿®æ”¹</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const BatchImportModal = ({ isOpen, onClose, activeTab, onImport }) => {
            const [jsonInput, setJsonInput] = useState('');
            const [status, setStatus] = useState('');
            const handleImport = async () => {
                try {
                    const parsedData = JSON.parse(jsonInput);
                    if (!Array.isArray(parsedData)) throw new Error("è¼¸å…¥æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯ JSON é™£åˆ— [...]");
                    setStatus('åŒ¯å…¥ä¸­...');
                    await onImport(parsedData);
                    setStatus(`æˆåŠŸåŒ¯å…¥ ${parsedData.length} ç­†è³‡æ–™ï¼`);
                    setTimeout(() => { setStatus(''); setJsonInput(''); onClose(); }, 1500);
                } catch (e) { setStatus('éŒ¯èª¤ï¼š' + e.message); }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
                        <h3 className="text-xl font-bold mb-2">æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™ ({activeTab})</h3>
                        <p className="text-sm text-slate-500 mb-4">è«‹è²¼ä¸Š JSON æ ¼å¼çš„é™£åˆ—è³‡æ–™ã€‚</p>
                        <textarea className="w-full h-64 border p-2 rounded font-mono text-sm" value={jsonInput} onChange={e => setJsonInput(e.target.value)} placeholder="åœ¨æ­¤è²¼ä¸Š JSON è³‡æ–™..."></textarea>
                        {status && <p className={`mt-2 text-sm ${status.includes('éŒ¯èª¤') ? 'text-red-600' : 'text-green-600'}`}>{status}</p>}
                        <div className="flex justify-end space-x-3 mt-4"><button onClick={onClose} className="px-4 py-2 border rounded">é—œé–‰</button><button onClick={handleImport} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">é–‹å§‹åŒ¯å…¥</button></div>
                    </div>
                </div>
            );
        };

        const AdminApp = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('news');
            const [dataList, setDataList] = useState([]);
            const [loading, setLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [isPwdModalOpen, setIsPwdModalOpen] = useState(false);
            const [isBatchModalOpen, setIsBatchModalOpen] = useState(false);
            const [viewingAlbum, setViewingAlbum] = useState(null); 
            const [isEditorOpen, setIsEditorOpen] = useState(false);
            const [editItem, setEditItem] = useState({});
            const [forceUpdate, setForceUpdate] = useState(0);
            const [hasLocalData, setHasLocalData] = useState(false);

            useEffect(() => {
                const tabs = ['news', 'projects', 'members', 'publications', 'gallery'];
                const hasData = tabs.some(t => {
                    try { return JSON.parse(localStorage.getItem('smsmp_' + t) || '[]').length > 0; }
                    catch { return false; }
                });
                setHasLocalData(hasData);
            }, [activeTab, forceUpdate]);

            useEffect(() => { window.forceUpdate = () => setForceUpdate(s => s + 1); }, []);

            const albumGroups = useMemo(() => {
                if (activeTab !== 'gallery') return {};
                const groups = {};
                (dataList || []).forEach(item => {
                    const t = item.title || '(æœªå‘½å)';
                    if (!groups[t]) groups[t] = [];
                    groups[t].push(item);
                });
                return groups;
            }, [dataList, activeTab]);

            const displayList = useMemo(() => {
                if (activeTab === 'gallery' && viewingAlbum) return (dataList || []).filter(d => (d.title || '(æœªå‘½å)') === viewingAlbum);
                return dataList || [];
            }, [dataList, activeTab, viewingAlbum]);

            useEffect(() => {
                if (isLoggedIn) {
                    window.dbOps.signIn().then(() => window.dbOps.onAuth(setUser));
                }
            }, [isLoggedIn, forceUpdate]);

            useEffect(() => { if (user) loadData(); }, [activeTab, user]);

            const loadData = async () => {
                setLoading(true);
                try {
                    const list = await window.dbOps.fetch(activeTab);
                    list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    setDataList(list);
                } catch(e) { console.error(e); }
                setLoading(false);
            };

            const handleSave = async (data) => {
                try {
                    if (data.id) await window.dbOps.update(activeTab, data.id, data);
                    else await window.dbOps.add(activeTab, data);
                    loadData();
                    return true;
                } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); throw e; }
            };

            const handleBatchSave = async (items) => {
                try { await window.dbOps.batchAdd(activeTab, items); loadData(); return true; } 
                catch(e) { alert("æ‰¹æ¬¡å„²å­˜å¤±æ•—: " + e.message); throw e; }
            };
            
            const uploadLocalData = async () => {
                if (!confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰æœ¬æ©Ÿæš«å­˜è³‡æ–™ä¸Šå‚³è‡³é›²ç«¯å—ï¼Ÿ")) return;
                setLoading(true);
                try {
                    const tabs = ['news', 'projects', 'members', 'publications', 'gallery'];
                    let totalCount = 0;
                    for (const tab of tabs) {
                        const localItems = JSON.parse(localStorage.getItem('smsmp_' + tab) || '[]');
                        if (localItems.length > 0) {
                            const cleanItems = localItems.map(({id, ...rest}) => rest);
                            await window.dbOps.batchAdd(tab, cleanItems);
                            localStorage.removeItem('smsmp_' + tab);
                            totalCount += localItems.length;
                        }
                    }
                    alert(`æˆåŠŸä¸Šå‚³ ${totalCount} ç­†è³‡æ–™ï¼`);
                    setHasLocalData(false);
                    loadData();
                } catch(e) { alert("ä¸Šå‚³å¤±æ•—: " + e.message); }
                setLoading(false);
            };

            const handleDelete = async (id) => {
                if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await window.dbOps.delete(activeTab, id); loadData(); }
            };
            
            const ChangePwd = () => setIsPwdModalOpen(true);
            const BatchImport = () => setIsBatchModalOpen(true);
            const ResetDB = () => window.dbOps.initDefaults(defaultData).then(loadData);

            if (!isLoggedIn) return <LoginForm onLogin={() => setIsLoggedIn(true)} />;
            if (!user) return <div className="min-h-screen flex items-center justify-center text-gray-500">ç³»çµ±è¼‰å…¥ä¸­...</div>;

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <div className="w-full md:w-64 bg-slate-800 text-white p-6 flex-shrink-0">
                        <h1 className="text-xl font-bold mb-8">å¯¦é©—å®¤å¾Œå°</h1>
                        <nav className="space-y-2">
                            {Object.keys(TAB_NAMES).map(t => (
                                <button key={t} onClick={() => { setActiveTab(t); setViewingAlbum(null); }} className={`w-full text-left px-4 py-2 rounded ${activeTab===t ? 'bg-blue-600' : 'hover:bg-slate-700'}`}>{TAB_NAMES[t]}</button>
                            ))}
                        </nav>
                        <div className="mt-4 pt-4 border-t border-slate-700 space-y-2">
                             {!window.isLocal && hasLocalData && (
                                <button onClick={uploadLocalData} className="w-full bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded text-sm transition-colors animate-pulse font-bold">â˜ï¸ ä¸Šå‚³æœ¬æ©Ÿæš«å­˜è³‡æ–™</button>
                             )}
                             <button onClick={BatchImport} className="w-full bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors">ğŸ“‹ æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™</button>
                             <button onClick={ChangePwd} className="w-full bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded text-sm transition-colors">ğŸ”’ ä¿®æ”¹å¯†ç¢¼</button>
                             <button onClick={ResetDB} className="w-full bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded text-sm transition-colors">åˆå§‹åŒ–/é‡ç½®è³‡æ–™åº«</button>
                        </div>
                    </div>
                    
                    <div className="flex-grow p-8 overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold flex items-center gap-2">
                                {activeTab === 'gallery' && viewingAlbum && <button onClick={() => setViewingAlbum(null)} className="text-blue-500 hover:underline">â†</button>}
                                {activeTab === 'gallery' && viewingAlbum ? viewingAlbum : TAB_NAMES[activeTab]}
                            </h2>
                            <button onClick={() => { setEditItem(viewingAlbum ? {title: viewingAlbum} : {}); setIsEditorOpen(true); }} className="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">+ æ–°å¢</button>
                        </div>

                        {loading ? <p>è¼‰å…¥ä¸­...</p> : (
                            <div className="bg-white rounded shadow p-6">
                                {activeTab === 'gallery' && !viewingAlbum ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {Object.entries(albumGroups).map(([title, items]) => (
                                            <div key={title} onClick={() => setViewingAlbum(title)} className="border rounded p-4 cursor-pointer hover:bg-blue-50 flex flex-col items-center text-center">
                                                <FolderIcon />
                                                <span className="font-bold">{title}</span>
                                                <span className="text-xs text-gray-500">{items.length} å¼µ</span>
                                            </div>
                                        ))}
                                        {Object.keys(albumGroups).length === 0 && <p className="col-span-full text-center text-gray-400">å°šç„¡ç›¸ç°¿</p>}
                                    </div>
                                ) : (
                                    <table className="w-full text-left">
                                        <thead><tr className="border-b text-gray-500"><th className="p-3">æ¨™é¡Œ / å…§å®¹</th><th className="p-3">æ“ä½œ</th></tr></thead>
                                        <tbody>
                                            {displayList.map(item => (
                                                <tr key={item.id} className="border-b hover:bg-gray-50">
                                                    <td className="p-3">
                                                        <div className="font-bold">{item.title || item.name}</div>
                                                        <div className="text-xs text-gray-500 truncate max-w-md">{item.desc || item.research}</div>
                                                        {(item.src || item.photo || item.image) && <span className="text-[10px] bg-green-100 text-green-800 px-1 rounded">IMG</span>}
                                                    </td>
                                                    <td className="p-3">
                                                        <button onClick={() => { setEditItem(item); setIsEditorOpen(true); }} className="text-blue-600 mr-3">ç·¨è¼¯</button>
                                                        <button onClick={() => handleDelete(item.id)} className="text-red-600">åˆªé™¤</button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {displayList.length === 0 && <tr><td colSpan="2" className="p-4 text-center text-gray-400">ç„¡è³‡æ–™</td></tr>}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {isEditorOpen && <EditorModal activeTab={activeTab} initData={editItem} onSave={handleSave} onBatchSave={handleBatchSave} onClose={() => setIsEditorOpen(false)} />}
                    <ChangePasswordModal isOpen={isPwdModalOpen} onClose={() => setIsPwdModalOpen(false)} />
                    <BatchImportModal isOpen={isBatchModalOpen} onClose={() => setIsBatchModalOpen(false)} activeTab={activeTab} onImport={handleBatchSave} />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><AdminApp /></ErrorBoundary>);
    </script>
</body>
</html>