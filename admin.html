<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦é©—å®¤å¾Œå°ç®¡ç†ç³»çµ± (Admin Dashboard)</title>
    
    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global Error:', msg, error);
            if (msg.indexOf("Script error") > -1) return true;
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 1. Local Ops Definition (Fallback) -->
    <script>
        window.isLocal = true;
        window.appId = 'default-app-id';
        
        // Helper to check size
        const checkQuota = (data) => {
            const size = new Blob([JSON.stringify(data)]).size;
            if (size > 4.5 * 1024 * 1024) { // 4.5MB safety limit
                throw new Error("æœ¬æ©Ÿå„²å­˜ç©ºé–“ä¸è¶³ (ä¸Šé™ç´„ 5MB)ã€‚è«‹ä½¿ç”¨ Firebase é›²ç«¯æ¨¡å¼æˆ–æ¸›å°‘åœ–ç‰‡æ•¸é‡/å¤§å°ã€‚");
            }
        };

        const localOps = {
            mode: 'LOCAL',
            signIn: async () => { console.log("Local Sign In"); return true; },
            onAuth: (cb) => { setTimeout(() => cb({ uid: 'local-admin', email: 'admin@local' }), 50); return () => {}; },
            fetch: async (colName) => {
                try { return JSON.parse(localStorage.getItem('smsmp_' + colName) || '[]'); } catch (e) { return []; }
            },
            add: async (colName, data) => {
                const list = JSON.parse(localStorage.getItem('smsmp_' + colName) || '[]');
                const newItem = { ...data, id: 'loc_' + Date.now(), createdAt: Date.now() };
                const newList = [...list, newItem];
                checkQuota(newList);
                localStorage.setItem('smsmp_' + colName, JSON.stringify(newList));
                return newItem;
            },
            update: async (colName, id, data) => {
                const list = JSON.parse(localStorage.getItem('smsmp_' + colName) || '[]');
                const idx = list.findIndex(i => i.id === id);
                if (idx !== -1) {
                    list[idx] = { ...list[idx], ...data };
                    checkQuota(list);
                    localStorage.setItem('smsmp_' + colName, JSON.stringify(list));
                }
            },
            delete: async (colName, id) => {
                const list = JSON.parse(localStorage.getItem('smsmp_' + colName) || '[]');
                const newList = list.filter(i => i.id !== id);
                localStorage.setItem('smsmp_' + colName, JSON.stringify(newList));
            },
            batchAdd: async (colName, items) => {
                const list = JSON.parse(localStorage.getItem('smsmp_' + colName) || '[]');
                const newItems = items.map((item, idx) => ({
                    ...item,
                    id: 'batch_' + Date.now() + '_' + idx,
                    createdAt: item.createdAt || (Date.now() - idx * 100)
                }));
                const newList = [...list, ...newItems];
                checkQuota(newList); // Critical check for gallery
                localStorage.setItem('smsmp_' + colName, JSON.stringify(newList));
            },
            initDefaults: async (defaultData) => {
                for (const [key, items] of Object.entries(defaultData)) {
                    const current = JSON.parse(localStorage.getItem('smsmp_' + key) || '[]');
                    if (current.length === 0) {
                        const newItems = items.map((i, idx) => ({ ...i, id: `init_${idx}`, createdAt: Date.now() - (idx * 1000) }));
                        localStorage.setItem('smsmp_' + key, JSON.stringify(newItems));
                    }
                }
            }
        };

        // Initialize immediately with Local Ops
        window.dbOps = localOps;
    </script>

    <!-- 2. Firebase SDKs & Config -->
    <script type="module">
        (async () => {
            try {
                // â˜…â˜…â˜… Firebase Config (å·²å¡«å…¥) â˜…â˜…â˜…
                const userFirebaseConfig = {
                    apiKey: "AIzaSyB-3Pl_9_lQUUyfEzULjgnfgB8Xbivo5rY",
                    authDomain: "lab-website-40cb1.firebaseapp.com",
                    projectId: "lab-website-40cb1",
                    storageBucket: "lab-website-40cb1.firebasestorage.app",
                    messagingSenderId: "44092173556",
                    appId: "1:44092173556:web:c8283c28b229c01d4e42a1",
                    measurementId: "G-MYBL65WHRM"
                };

                let firebaseConfig = userFirebaseConfig;
                if (typeof __firebase_config !== 'undefined') {
                     // firebaseConfig = JSON.parse(__firebase_config); 
                }

                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, writeBatch } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const appId = 'default-app-id';

                // Define Firebase Ops
                const firebaseOps = {
                    mode: 'FIREBASE',
                    signIn: async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Failed:", error);
                            alert("âš ï¸ ç„¡æ³•é€£ç·šè‡³é›²ç«¯è³‡æ–™åº« (Auth Error)\n\nå¯èƒ½åŸå› ï¼šFirebase æœªå•Ÿç”¨ã€ŒåŒ¿åç™»å…¥ã€ã€‚\nç³»çµ±å°‡è‡ªå‹•åˆ‡æ›è‡³æœ¬æ©Ÿæ¨¡å¼ã€‚");
                            window.dbOps = localOps; 
                            window.isLocal = true;
                            if(window.forceUpdate) window.forceUpdate();
                        }
                    },
                    onAuth: (cb) => onAuthStateChanged(auth, cb),
                    fetch: async (colName) => {
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', colName);
                        const snapshot = await getDocs(colRef);
                        return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    },
                    add: async (colName, data) => {
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', colName);
                        await addDoc(colRef, { ...data, createdAt: data.createdAt || Date.now() });
                    },
                    update: async (colName, id, data) => {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', colName, id);
                        await updateDoc(docRef, data);
                    },
                    delete: async (colName, id) => {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', colName, id);
                        await deleteDoc(docRef);
                    },
                    batchAdd: async (colName, items) => {
                        const batch = writeBatch(db);
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', colName);
                        items.forEach((item, idx) => {
                             const docRef = doc(colRef);
                             const data = { ...item, createdAt: item.createdAt || (Date.now() - idx * 100) };
                             batch.set(docRef, data);
                        });
                        await batch.commit();
                    },
                    initDefaults: async (defaultData) => {
                        const batch = writeBatch(db);
                        for (const [key, items] of Object.entries(defaultData)) {
                            const colRef = collection(db, 'artifacts', appId, 'public', 'data', key);
                            const snapshot = await getDocs(colRef);
                            if (snapshot.empty) {
                                items.forEach((item, idx) => {
                                    const docRef = doc(colRef);
                                    batch.set(docRef, { ...item, createdAt: Date.now() - (idx * 1000) });
                                });
                            }
                        }
                        await batch.commit();
                    }
                };

                window.dbOps = firebaseOps;
                window.isLocal = false;
                console.log("ğŸ”¥ Firebase SDK Loaded");
                if (window.forceUpdate) window.forceUpdate();

            } catch (e) {
                console.warn("âš ï¸ Firebase failed, staying in Local Mode", e);
            }
        })();
    </script>
</head>
<body class="bg-gray-100 font-sans text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return <div className="min-h-screen flex items-center justify-center bg-red-50 p-4"><div className="bg-white p-6 rounded shadow text-center text-red-600">ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ã€‚<br/><span className="text-sm text-gray-500">{this.state.error?.message}</span></div></div>;
                }
                return this.props.children;
            }
        }

        const CRED_KEY_USER = 'smsmp_admin_user';
        const CRED_KEY_PASS = 'smsmp_admin_pass';
        const DEFAULT_USER = 'Yflin';
        const DEFAULT_PASS = '0701';

        const getCredentials = () => ({
            username: localStorage.getItem(CRED_KEY_USER) || DEFAULT_USER,
            password: localStorage.getItem(CRED_KEY_PASS) || DEFAULT_PASS
        });

        const updateCredentials = (u, p) => { localStorage.setItem(CRED_KEY_USER, u); localStorage.setItem(CRED_KEY_PASS, p); };

        const defaultData = {
            news: [{ date: "2025-11-06", title: "æ¦®ç²å°ç£ç²¾å¯†å·¥ç¨‹å­¸æœƒ å°ˆé¡Œèˆ‡è«–æ–‡ç ä½³ä½œ", tag: "Award" }],
            projects: [{ type: "government", year: "2025", title: "NSTC-114 è¨ˆç•«", role: "ä¸»æŒäºº" }],
            members: [{ type: 'pi', name: "æ—å²³é‹’", year: "", research: "å‰µæ–°é«˜æ•ˆèƒ½åŠ å·¥" }],
            gallery: [],
            publications: [{ year: "2025", title: "Scalable Real-time Energy Monitoring...", venue: "Sensors" }]
        };

        const TAB_NAMES = { news: 'æœ€æ–°æ¶ˆæ¯', projects: 'æ­·å¹´è¨ˆç•«', members: 'æˆå“¡ç®¡ç†', publications: 'ç™¼è¡¨è«–æ–‡', gallery: 'ç”Ÿæ´»å¯«çœŸ' };
        const FolderIcon = ({ className = "w-16 h-16 text-yellow-400 mb-2 drop-shadow-sm group-hover:scale-110 transition-transform" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path d="M19.5 21a3 3 0 0 0 3-3v-4.5a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3h15ZM1.5 10.146V6a3 3 0 0 1 3-3h5.379a2.25 2.25 0 0 1 1.59.659l2.122 2.121c.14.141.331.22.53.22H19.5a3 3 0 0 1 3 3v1.146A4.483 4.483 0 0 0 19.5 9h-15a4.483 4.483 0 0 0-3 1.146Z" />
            </svg>
        );

        const LoginForm = ({ onLogin }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            const [err, setErr] = useState('');
            const [localMode, setLocalMode] = useState(window.isLocal);
            useEffect(() => { const i = setInterval(() => setLocalMode(window.isLocal), 500); return () => clearInterval(i); }, []);
            const handleSubmit = (e) => {
                e.preventDefault();
                const creds = getCredentials();
                if (u === creds.username && p === creds.password) onLogin();
                else setErr('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm border border-slate-200">
                        <h2 className="text-xl font-bold mb-6 text-center text-slate-800">å¾Œå°ç™»å…¥</h2>
                        <div className={`mb-4 text-xs p-2 rounded flex items-center ${localMode ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                            <span className="mr-2">{localMode ? 'âš ï¸' : 'âœ…'}</span> 
                            <span>{localMode ? 'æœ¬æ©Ÿæ¨¡å¼ (Firebase æœªé€£ç·š)' : 'å·²é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«'}</span>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full border p-2 rounded" placeholder="å¸³è™Ÿ" value={u} onChange={e=>setU(e.target.value)} required />
                            <input className="w-full border p-2 rounded" type="password" placeholder="å¯†ç¢¼" value={p} onChange={e=>setP(e.target.value)} required />
                            {err && <p className="text-red-500 text-center text-sm">{err}</p>}
                            <button className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition-colors">ç™»å…¥</button>
                        </form>
                    </div>
                </div>
            );
        };

        const EditorModal = ({ activeTab, initData, onSave, onBatchSave, onClose }) => {
            const [formData, setFormData] = useState({});
            const [galleryImages, setGalleryImages] = useState([]);
            const [coverIndex, setCoverIndex] = useState(0);
            const [customInput, setCustomInput] = useState({ year: false, role: false, classYear: false, yearDisplay: false });
            const [isSaving, setIsSaving] = useState(false); // New state for visual feedback

            useEffect(() => {
                const d = { ...initData };
                if (activeTab === 'members' && !d.type) d.type = 'master';
                if (!d.id) {
                    if (activeTab === 'projects') d.type = 'government';
                    if (activeTab === 'members') d.year = 'ç¢©ä¸€';
                    if (activeTab === 'news') d.tag = 'Activity';
                }
                setFormData(d);
                if (activeTab === 'gallery') {
                    setGalleryImages(d.src ? [{src: d.src, id: 'init'}] : []);
                    setCoverIndex(0);
                }
                setCustomInput({ year: false, role: false, classYear: false, yearDisplay: false });
            }, [initData, activeTab]);

            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            
            const handleFiles = (e) => {
                Array.from(e.target.files).forEach(file => {
                    if (file.size > 800 * 1024) { alert('æª”æ¡ˆéå¤§ (Max 800KB)'); return; }
                    const reader = new FileReader();
                    reader.onload = () => {
                        if (activeTab === 'gallery') {
                            setGalleryImages(prev => [...prev, { src: reader.result, id: Math.random() }]);
                        } else {
                            const field = activeTab === 'members' ? 'photo' : 'image';
                            setFormData(prev => ({ ...prev, [field]: reader.result }));
                        }
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handlePaste = (e) => {
                if (activeTab !== 'gallery') return;
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        const blob = items[i].getAsFile();
                        const reader = new FileReader();
                        reader.onload = () => setGalleryImages(prev => [...prev, { src: reader.result, id: Math.random() }]);
                        reader.readAsDataURL(blob);
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                try {
                    if (activeTab === 'gallery' && !formData.id && galleryImages.length > 0) {
                        const items = galleryImages.map((img, idx) => {
                            const offset = idx === coverIndex ? 0 : (idx + 1) * 1000;
                            return { ...formData, src: img.src, createdAt: Date.now() - offset };
                        });
                        // Pass activeTab as first arg as required by dbOps.batchAdd
                        await onBatchSave(items); 
                        onClose();
                    } else {
                        if (activeTab === 'gallery' && galleryImages.length > 0) formData.src = galleryImages[0].src;
                        await onSave(formData);
                        onClose();
                    }
                } catch (err) {
                    console.error(err);
                    alert("å„²å­˜ç™¼ç”ŸéŒ¯èª¤: " + err.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const isMember = activeTab === 'members';
            const isGallery = activeTab === 'gallery';
            const isPI = formData.type === 'pi';
            const isAlumni = formData.type === 'alumni';
            const isStudent = ['master', 'phd'].includes(formData.type);
            const yearOptions = [];
            for (let y = 116; y >= 105; y--) yearOptions.push({ val: String(y), label: `æ°‘åœ‹ ${y} å¹´` });
            for (let y = 2030; y >= 2016; y--) yearOptions.push({ val: String(y), label: `è¥¿å…ƒ ${y} å¹´` });
            
            let currentYearSelectValue = 'custom';
            if (!customInput.year && formData.year && yearOptions.some(o => o.val === formData.year)) { 
                currentYearSelectValue = formData.year; 
            }

            let currentTypeSelect = 'government';
            const predefinedTypes = ['government', 'industry', 'patent', 'competition', 'student_project'];
            if (formData.type && predefinedTypes.includes(formData.type)) currentTypeSelect = formData.type; 
            else if (formData.type) currentTypeSelect = 'other';
            
            const memberClassYears = [];
            for (let y = 116; y >= 80; y--) memberClassYears.push(String(y));
            const memberYearDisplays = ["ç¢©ä¸€", "ç¢©äºŒ", "ç¢©ä¸‰", "åšä¸€", "åšäºŒ", "åšä¸‰", "åšå››", "åšäº”"];

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onPaste={handlePaste}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <h3 className="text-xl font-bold">{formData.id ? 'ç·¨è¼¯' : 'æ–°å¢'} {isGallery ? '(ç›¸ç°¿æ¨¡å¼)' : ''}</h3>
                            <div>
                                <label className="block text-sm font-bold mb-1">{isMember ? 'å§“å' : 'æ¨™é¡Œ'}</label>
                                <input required name={isMember ? 'name' : 'title'} value={(isMember ? formData.name : formData.title) || ''} onChange={handleChange} className="w-full border p-2 rounded" />
                                {isGallery && <p className="text-xs text-gray-500 mt-1">ç›¸åŒæ¨™é¡Œçš„ç…§ç‰‡æœƒè‡ªå‹•æ­¸é¡ç‚ºåŒä¸€æœ¬ç›¸ç°¿ã€‚</p>}
                            </div>
                            
                            {/* Member Specific Fields */}
                            {isMember && (
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-1">èº«åˆ†</label>
                                        <select name="type" value={formData.type} onChange={handleChange} className="w-full border p-2 rounded">
                                            <option value="pi">æŒ‡å°æ•™æˆ</option>
                                            <option value="phd">åšå£«ç”Ÿ</option>
                                            <option value="master">ç¢©å£«ç”Ÿ</option>
                                            <option value="alumni">ç•¢æ¥­æ ¡å‹</option>
                                        </select>
                                    </div>
                                    <div>
                                        {isAlumni ? (
                                            <>
                                                <label className="block text-sm font-bold mb-1">ç•¢æ¥­ç´šåˆ¥</label>
                                                {!customInput.classYear ? (
                                                    <select name="classYear" value={memberClassYears.includes(formData.classYear) ? formData.classYear : 'custom'} onChange={(e) => {
                                                        if(e.target.value === 'custom') setCustomInput(p => ({...p, classYear: true}));
                                                        else setFormData(p => ({...p, classYear: e.target.value}));
                                                    }} className="w-full border p-2 rounded">
                                                        <option value="" disabled>è«‹é¸æ“‡</option>
                                                        {memberClassYears.map(y => <option key={y} value={y}>{y}ç´š</option>)}
                                                        <option value="custom">è‡ªè¨‚...</option>
                                                    </select>
                                                ) : (
                                                    <div className="flex gap-2"><input name="classYear" value={formData.classYear||''} onChange={handleChange} className="w-full border p-2 rounded" placeholder="e.g. 113" /><button type="button" onClick={() => setCustomInput(p=>({...p, classYear: false}))} className="px-2 bg-gray-200 rounded text-xs">é¸å–®</button></div>
                                                )}
                                            </>
                                        ) : (isStudent && (
                                            <>
                                                <label className="block text-sm font-bold mb-1">å¹´ç´š</label>
                                                {!customInput.yearDisplay ? (
                                                    <select name="year" value={memberYearDisplays.includes(formData.year) ? formData.year : 'custom'} onChange={(e) => {
                                                        if(e.target.value === 'custom') setCustomInput(p => ({...p, yearDisplay: true}));
                                                        else setFormData(p => ({...p, year: e.target.value}));
                                                    }} className="w-full border p-2 rounded">
                                                        <option value="" disabled>è«‹é¸æ“‡</option>
                                                        {memberYearDisplays.map(y => <option key={y} value={y}>{y}</option>)}
                                                        <option value="custom">è‡ªè¨‚...</option>
                                                    </select>
                                                ) : (
                                                    <div className="flex gap-2"><input name="year" value={formData.year || ''} onChange={handleChange} placeholder="e.g. ç¢©ä¸€" className="w-full border p-2 rounded" /><button type="button" onClick={() => setCustomInput(p=>({...p, yearDisplay: false}))} className="px-2 bg-gray-200 rounded text-xs">é¸å–®</button></div>
                                                )}
                                            </>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* News Date */}
                            {activeTab === 'news' && <input type="date" name="date" value={formData.date||''} onChange={handleChange} className="w-full border p-2 rounded" />}
                            
                            {/* Projects Fields */}
                            {activeTab === 'projects' && (
                                <>
                                    <label className="block"><span className="text-sm font-bold">å¹´åº¦</span>
                                        {!customInput.year ? (
                                            <select name="year" value={currentYearSelectValue} onChange={handleChange} className="w-full border p-2 rounded mt-1"><option value="" disabled>è«‹é¸æ“‡å¹´åº¦</option>{yearOptions.map(opt => <option key={opt.val} value={opt.val}>{opt.label}</option>)}<option value="custom">è‡ªè¨‚...</option></select>
                                        ) : <div className="flex gap-2"><input name="year" value={formData.year || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1" /><button type="button" onClick={() => setCustomInput(p=>({...p, year: false}))} className="px-2 bg-gray-200 rounded mt-1 text-xs">é¸å–®</button></div>}
                                    </label>
                                    <input name="type" placeholder="é¡å‹" value={formData.type||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                    <input name="agency" placeholder="å–®ä½" value={formData.agency||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                    <input name="role" placeholder="æ“”ä»»è§’è‰²" value={formData.role||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                    <textarea name="desc" placeholder="èªªæ˜" value={formData.desc||''} onChange={handleChange} className="w-full border p-2 rounded" />
                                </>
                            )}

                            {isGallery ? (
                                <div className="border-2 border-dashed p-4 rounded bg-gray-50">
                                    <div className="flex justify-between mb-2">
                                        <label className="font-bold text-sm">ç›¸ç°¿ç…§ç‰‡ (å¤šé¸/è²¼ä¸Š)</label>
                                        <span className="text-xs bg-green-100 text-green-800 px-2 rounded">é»æ“Šè¨­ç‚ºå°é¢</span>
                                    </div>
                                    <input type="file" accept="image/*" multiple onChange={handleFiles} className="mb-2 w-full text-sm" />
                                    <div className="grid grid-cols-4 gap-2">
                                        {galleryImages.map((img, idx) => (
                                            <div key={idx} onClick={() => setCoverIndex(idx)} className={`relative aspect-square cursor-pointer border-2 ${idx===coverIndex ? 'border-green-500' : 'border-transparent'}`}>
                                                <img src={img.src} className="w-full h-full object-cover" />
                                                {idx===coverIndex && <div className="absolute top-0 left-0 bg-green-500 text-white text-[10px] px-1">å°é¢</div>}
                                                <button type="button" onClick={(e)=>{e.stopPropagation();setGalleryImages(prev=>prev.filter((_,i)=>i!==idx))}} className="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center rounded-bl">Ã—</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                ['news', 'members'].includes(activeTab) && (
                                    <div>
                                        <label className="block text-sm font-bold mb-1">åœ–ç‰‡</label>
                                        <input type="file" accept="image/*" onChange={handleFiles} className="w-full border p-2 rounded text-sm" />
                                        {formData[activeTab==='members'?'photo':'image'] && <img src={formData[activeTab==='members'?'photo':'image']} className="h-20 mt-2 border rounded" />}
                                    </div>
                                )
                            )}
                            
                            {isMember && (
                                <>
                                    <input name="research" placeholder={isPI ? 'æ ¸å¿ƒç ”ç©¶é ˜åŸŸ' : 'ç ”ç©¶ä¸»é¡Œ'} value={formData.research || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>
                                    <textarea name="researchDetail" placeholder={isPI ? 'å­¸è¡“ç°¡ä»‹' : 'è©³ç´°å…§å®¹'} value={formData.researchDetail || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1 h-20"/>
                                    <input name="email" placeholder="Email" value={formData.email || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>
                                    {isPI && <input name="phone" placeholder="é›»è©±" value={formData.phone || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>}
                                    <textarea name="awards" placeholder={isPI ? 'æ•™å­¸ç‰¹è‰²' : 'ç²çç´€éŒ„'} value={formData.awards || ''} onChange={handleChange} className="w-full border p-2 rounded mt-1"/>
                                </>
                            )}
                            {activeTab === 'publications' && <input name="venue" placeholder="æœŸåˆŠ/ç ”è¨æœƒ" value={formData.venue||''} onChange={handleChange} className="w-full border p-2 rounded"/>}
                            {activeTab === 'gallery' && <input name="desc" placeholder="ç›¸ç°¿æè¿°" value={formData.desc||''} onChange={handleChange} className="w-full border p-2 rounded" />}

                            <div className="flex justify-end gap-2 pt-4">
                                <button type="button" onClick={onClose} disabled={isSaving} className="px-4 py-2 border rounded disabled:opacity-50">å–æ¶ˆ</button>
                                <button type="submit" disabled={isSaving} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                    {isSaving ? 'è™•ç†ä¸­...' : 'å„²å­˜'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ChangePasswordModal = ({ isOpen, onClose }) => {
            const [oldUser, setOldUser] = useState('');
            const [oldPass, setOldPass] = useState('');
            const [newPass, setNewPass] = useState('');
            const [confirmPass, setConfirmPass] = useState('');
            const [msg, setMsg] = useState({ type: '', text: '' });
            const handleSubmit = (e) => {
                e.preventDefault();
                const current = getCredentials();
                if (oldUser !== current.username || oldPass !== current.password) { setMsg({ type: 'error', text: 'èˆŠå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤' }); return; }
                if (newPass !== confirmPass) { setMsg({ type: 'error', text: 'å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´' }); return; }
                if (newPass.length < 4) { setMsg({ type: 'error', text: 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 4 ç¢¼' }); return; }
                updateCredentials(current.username, newPass); 
                setMsg({ type: 'success', text: 'å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼' });
                setTimeout(() => { setMsg({ type: '', text: '' }); onClose(); }, 1500);
            };
            useEffect(() => { if(isOpen) { setOldUser(''); setOldPass(''); setNewPass(''); setConfirmPass(''); setMsg({type:'', text:''}); } }, [isOpen]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                        <h3 className="text-xl font-bold mb-4">ä¿®æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
                        {msg.text && <div className={`p-2 mb-4 rounded text-sm ${msg.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{msg.text}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded border border-slate-200"><input type="text" placeholder="ç›®å‰çš„å¸³è™Ÿ" value={oldUser} onChange={e => setOldUser(e.target.value)} className="w-full border p-2 rounded mb-2 text-sm" required /><input type="password" placeholder="ç›®å‰çš„å¯†ç¢¼" value={oldPass} onChange={e => setOldPass(e.target.value)} className="w-full border p-2 rounded text-sm" required /></div>
                            <div className="bg-blue-50 p-3 rounded border border-blue-100"><input type="password" placeholder="æ–°å¯†ç¢¼" value={newPass} onChange={e => setNewPass(e.target.value)} className="w-full border p-2 rounded mb-2 text-sm" required /><input type="password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" value={confirmPass} onChange={e => setConfirmPass(e.target.value)} className="w-full border p-2 rounded text-sm" required /></div>
                            <div className="flex justify-end space-x-3 mt-4"><button type="button" onClick={onClose} className="px-4 py-2 border rounded text-slate-600 hover:bg-slate-50">å–æ¶ˆ</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ç¢ºèªä¿®æ”¹</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const BatchImportModal = ({ isOpen, onClose, activeTab, onImport }) => {
            const [jsonInput, setJsonInput] = useState('');
            const [status, setStatus] = useState('');
            const handleImport = async () => {
                try {
                    const parsedData = JSON.parse(jsonInput);
                    if (!Array.isArray(parsedData)) throw new Error("è¼¸å…¥æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯ JSON é™£åˆ— [...]");
                    setStatus('åŒ¯å…¥ä¸­...');
                    await onImport(parsedData);
                    setStatus(`æˆåŠŸåŒ¯å…¥ ${parsedData.length} ç­†è³‡æ–™ï¼`);
                    setTimeout(() => { setStatus(''); setJsonInput(''); onClose(); }, 1500);
                } catch (e) { setStatus('éŒ¯èª¤ï¼š' + e.message); }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
                        <h3 className="text-xl font-bold mb-2">æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™ ({activeTab})</h3>
                        <p className="text-sm text-slate-500 mb-4">è«‹è²¼ä¸Š JSON æ ¼å¼çš„é™£åˆ—è³‡æ–™ã€‚</p>
                        <textarea className="w-full h-64 border p-2 rounded font-mono text-sm" value={jsonInput} onChange={e => setJsonInput(e.target.value)} placeholder="åœ¨æ­¤è²¼ä¸Š JSON è³‡æ–™..."></textarea>
                        {status && <p className={`mt-2 text-sm ${status.includes('éŒ¯èª¤') ? 'text-red-600' : 'text-green-600'}`}>{status}</p>}
                        <div className="flex justify-end space-x-3 mt-4"><button onClick={onClose} className="px-4 py-2 border rounded">é—œé–‰</button><button onClick={handleImport} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">é–‹å§‹åŒ¯å…¥</button></div>
                    </div>
                </div>
            );
        };

        const AdminApp = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('news');
            const [dataList, setDataList] = useState([]);
            const [loading, setLoading] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [isPwdModalOpen, setIsPwdModalOpen] = useState(false);
            const [isBatchModalOpen, setIsBatchModalOpen] = useState(false);
            const [viewingAlbum, setViewingAlbum] = useState(null); 
            const [isEditorOpen, setIsEditorOpen] = useState(false);
            const [editItem, setEditItem] = useState({});
            const [forceUpdate, setForceUpdate] = useState(0);
            const [hasLocalData, setHasLocalData] = useState(false);

            useEffect(() => {
                const tabs = ['news', 'projects', 'members', 'publications', 'gallery'];
                const hasData = tabs.some(t => {
                    try { return JSON.parse(localStorage.getItem('smsmp_' + t) || '[]').length > 0; }
                    catch { return false; }
                });
                setHasLocalData(hasData);
            }, [activeTab, forceUpdate]);

            useEffect(() => { window.forceUpdate = () => setForceUpdate(s => s + 1); }, []);

            const albumGroups = useMemo(() => {
                if (activeTab !== 'gallery') return {};
                const groups = {};
                (dataList || []).forEach(item => {
                    const t = item.title || '(æœªå‘½å)';
                    if (!groups[t]) groups[t] = [];
                    groups[t].push(item);
                });
                return groups;
            }, [dataList, activeTab]);

            const displayList = useMemo(() => {
                if (activeTab === 'gallery' && viewingAlbum) return (dataList || []).filter(d => (d.title || '(æœªå‘½å)') === viewingAlbum);
                return dataList || [];
            }, [dataList, activeTab, viewingAlbum]);

            useEffect(() => {
                if (isLoggedIn) {
                    window.dbOps.signIn().then(() => window.dbOps.onAuth(setUser));
                }
            }, [isLoggedIn, forceUpdate]);

            useEffect(() => { if (user) loadData(); }, [activeTab, user]);

            const loadData = async () => {
                setLoading(true);
                try {
                    const list = await window.dbOps.fetch(activeTab);
                    list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    setDataList(list);
                } catch(e) { console.error(e); }
                setLoading(false);
            };

            const handleSave = async (data) => {
                try {
                    if (data.id) await window.dbOps.update(activeTab, data.id, data);
                    else await window.dbOps.add(activeTab, data);
                    loadData();
                    return true;
                } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); throw e; }
            };

            const handleBatchSave = async (items) => {
                try { await window.dbOps.batchAdd(activeTab, items); loadData(); return true; } 
                catch(e) { alert("æ‰¹æ¬¡å„²å­˜å¤±æ•—: " + e.message); throw e; }
            };
            
            const uploadLocalData = async () => {
                if (!confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰æœ¬æ©Ÿæš«å­˜è³‡æ–™ä¸Šå‚³è‡³é›²ç«¯å—ï¼Ÿ")) return;
                setLoading(true);
                try {
                    const tabs = ['news', 'projects', 'members', 'publications', 'gallery'];
                    let totalCount = 0;
                    for (const tab of tabs) {
                        const localItems = JSON.parse(localStorage.getItem('smsmp_' + tab) || '[]');
                        if (localItems.length > 0) {
                            const cleanItems = localItems.map(({id, ...rest}) => rest);
                            await window.dbOps.batchAdd(tab, cleanItems);
                            localStorage.removeItem('smsmp_' + tab);
                            totalCount += localItems.length;
                        }
                    }
                    alert(`æˆåŠŸä¸Šå‚³ ${totalCount} ç­†è³‡æ–™ï¼`);
                    setHasLocalData(false);
                    loadData();
                } catch(e) { alert("ä¸Šå‚³å¤±æ•—: " + e.message); }
                setLoading(false);
            };

            const handleDelete = async (id) => {
                if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await window.dbOps.delete(activeTab, id); loadData(); }
            };
            
            const ChangePwd = () => setIsPwdModalOpen(true);
            const BatchImport = () => setIsBatchModalOpen(true);
            const ResetDB = () => window.dbOps.initDefaults(defaultData).then(loadData);

            if (!isLoggedIn) return <LoginForm onLogin={() => setIsLoggedIn(true)} />;
            if (!user) return <div className="min-h-screen flex items-center justify-center text-gray-500">ç³»çµ±è¼‰å…¥ä¸­...</div>;

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <div className="w-full md:w-64 bg-slate-800 text-white p-6 flex-shrink-0">
                        <h1 className="text-xl font-bold mb-8">å¯¦é©—å®¤å¾Œå°</h1>
                        <nav className="space-y-2">
                            {Object.keys(TAB_NAMES).map(t => (
                                <button key={t} onClick={() => { setActiveTab(t); setViewingAlbum(null); }} className={`w-full text-left px-4 py-2 rounded ${activeTab===t ? 'bg-blue-600' : 'hover:bg-slate-700'}`}>{TAB_NAMES[t]}</button>
                            ))}
                        </nav>
                        <div className="mt-4 pt-4 border-t border-slate-700 space-y-2">
                             {!window.isLocal && hasLocalData && (
                                <button onClick={uploadLocalData} className="w-full bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded text-sm transition-colors animate-pulse font-bold">â˜ï¸ ä¸Šå‚³æœ¬æ©Ÿæš«å­˜è³‡æ–™</button>
                             )}
                             <button onClick={BatchImport} className="w-full bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors">ğŸ“‹ æ‰¹æ¬¡åŒ¯å…¥è³‡æ–™</button>
                             <button onClick={ChangePwd} className="w-full bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded text-sm transition-colors">ğŸ”’ ä¿®æ”¹å¯†ç¢¼</button>
                             <button onClick={ResetDB} className="w-full bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded text-sm transition-colors">åˆå§‹åŒ–/é‡ç½®è³‡æ–™åº«</button>
                        </div>
                    </div>
                    
                    <div className="flex-grow p-8 overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold flex items-center gap-2">
                                {activeTab === 'gallery' && viewingAlbum && <button onClick={() => setViewingAlbum(null)} className="text-blue-500 hover:underline">â†</button>}
                                {activeTab === 'gallery' && viewingAlbum ? viewingAlbum : TAB_NAMES[activeTab]}
                            </h2>
                            <button onClick={() => { setEditItem(viewingAlbum ? {title: viewingAlbum} : {}); setIsEditorOpen(true); }} className="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">+ æ–°å¢</button>
                        </div>

                        {loading ? <p>è¼‰å…¥ä¸­...</p> : (
                            <div className="bg-white rounded shadow p-6">
                                {activeTab === 'gallery' && !viewingAlbum ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {Object.entries(albumGroups).map(([title, items]) => (
                                            <div key={title} onClick={() => setViewingAlbum(title)} className="border rounded p-4 cursor-pointer hover:bg-blue-50 flex flex-col items-center text-center">
                                                <FolderIcon />
                                                <span className="font-bold">{title}</span>
                                                <span className="text-xs text-gray-500">{items.length} å¼µ</span>
                                            </div>
                                        ))}
                                        {Object.keys(albumGroups).length === 0 && <p className="col-span-full text-center text-gray-400">å°šç„¡ç›¸ç°¿</p>}
                                    </div>
                                ) : (
                                    <table className="w-full text-left">
                                        <thead><tr className="border-b text-gray-500"><th className="p-3">æ¨™é¡Œ / å…§å®¹</th><th className="p-3">æ“ä½œ</th></tr></thead>
                                        <tbody>
                                            {displayList.map(item => (
                                                <tr key={item.id} className="border-b hover:bg-gray-50">
                                                    <td className="p-3">
                                                        <div className="font-bold">{item.title || item.name}</div>
                                                        <div className="text-xs text-gray-500 truncate max-w-md">{item.desc || item.research}</div>
                                                        {(item.src || item.photo || item.image) && <span className="text-[10px] bg-green-100 text-green-800 px-1 rounded">IMG</span>}
                                                    </td>
                                                    <td className="p-3">
                                                        <button onClick={() => { setEditItem(item); setIsEditorOpen(true); }} className="text-blue-600 mr-3">ç·¨è¼¯</button>
                                                        <button onClick={() => handleDelete(item.id)} className="text-red-600">åˆªé™¤</button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {displayList.length === 0 && <tr><td colSpan="2" className="p-4 text-center text-gray-400">ç„¡è³‡æ–™</td></tr>}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {isEditorOpen && <EditorModal activeTab={activeTab} initData={editItem} onSave={handleSave} onBatchSave={handleBatchSave} onClose={() => setIsEditorOpen(false)} />}
                    <ChangePasswordModal isOpen={isPwdModalOpen} onClose={() => setIsPwdModalOpen(false)} />
                    <BatchImportModal isOpen={isBatchModalOpen} onClose={() => setIsBatchModalOpen(false)} activeTab={activeTab} onImport={handleBatchSave} />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><AdminApp /></ErrorBoundary>);
    </script>
</body>
</html>